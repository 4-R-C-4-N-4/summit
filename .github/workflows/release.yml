name: Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  REGISTRY: ghcr.io

jobs:
  release-docker:
    name: Release Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Build image name
        id: image
        run: |
          # GitHub Container Registry requires lowercase
          REPO="${{ github.repository }}"
          IMAGE_NAME=$(echo "${REPO}" | tr '[:upper:]' '[:lower:]')
          echo "name=${REGISTRY}/${IMAGE_NAME}" >> $GITHUB_OUTPUT
        env:
          REGISTRY: ghcr.io

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/amd64
          tags: |
            ${{ steps.image.outputs.name }}:${{ steps.version.outputs.VERSION }}
            ${{ steps.image.outputs.name }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          body: |
            ## Summit Protocol ${{ steps.version.outputs.VERSION }}

            Peer-to-peer mesh networking for direct device communication.

            ### üê≥ Docker (Recommended)

            ```bash
            # Pull image
            docker pull ${{ steps.image.outputs.name }}:${{ steps.version.outputs.VERSION }}

            # Run Summit
            docker run -it --rm --privileged --network host \
              ${{ steps.image.outputs.name }}:${{ steps.version.outputs.VERSION }}

            # Inside container
            summitd wlp5s0

            # Access Web UI at http://127.0.0.1:9001
            ```

            ### üì¶ Docker Compose

            ```yaml
            services:
              summit:
                image: ${{ steps.image.outputs.name }}:${{ steps.version.outputs.VERSION }}
                privileged: true
                network_mode: host
                restart: unless-stopped
                command: summitd wlp5s0
            ```

            ### üì• Native Linux Binaries

            Download from Assets below:
            - `summit-x86_64-unknown-linux-gnu.tar.gz` for Intel/AMD 64-bit
            - `summit-aarch64-unknown-linux-gnu.tar.gz` for ARM64 (Raspberry Pi, etc.)

            ```bash
            # Extract and install
            tar xzf summit-x86_64-unknown-linux-gnu.tar.gz
            sudo mv summitd summit-ctl /usr/local/bin/

            # Run
            sudo summitd wlp5s0
            ```

            ### ‚ö° Quick Start

            ```bash
            # Check status
            summit-ctl status

            # List discovered peers
            summit-ctl peers

            # Trust a peer (both peers must trust each other)
            summit-ctl trust add <peer-pubkey>

            # Send a file (broadcasts to all trusted peers)
            summit-ctl send document.pdf

            # Access Web UI
            open http://127.0.0.1:9001
            ```

            ### üîê Security Features

            - ‚úÖ Noise_XX protocol encryption (same as WireGuard)
            - ‚úÖ Trust-based security model (mutual trust required)
            - ‚úÖ No automatic code execution
            - ‚úÖ Bounded resource usage
            - ‚úÖ Chunk buffering for untrusted peers

            ### üìö Documentation

            - Full documentation: https://github.com/${{ github.repository }}
            - Installation guide: https://github.com/${{ github.repository }}/blob/main/docs/DEPENDENCIES.md
            - API reference: https://github.com/${{ github.repository }}/blob/main/README.md#api-endpoints

            ### üêõ Known Issues

            - Linux only (requires IPv6 link-local and network namespaces)
            - Use Docker on macOS/Windows

            ### üìù Changelog

            See full changes in the auto-generated release notes below.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-binaries:
    name: Build Native Binaries (${{ matrix.target }})
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        target:
          - x86_64-unknown-linux-gnu
          - aarch64-unknown-linux-gnu
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Build binaries
        run: |
          cargo build --release --target ${{ matrix.target }} -p summitd
          cargo build --release --target ${{ matrix.target }} -p summit-ctl

      - name: Strip binaries
        run: |
          if [ "${{ matrix.target }}" = "aarch64-unknown-linux-gnu" ]; then
            aarch64-linux-gnu-strip target/${{ matrix.target }}/release/summitd || true
            aarch64-linux-gnu-strip target/${{ matrix.target }}/release/summit-ctl || true
          else
            strip target/${{ matrix.target }}/release/summitd || true
            strip target/${{ matrix.target }}/release/summit-ctl || true
          fi

      - name: Create archive
        run: |
          cd target/${{ matrix.target }}/release
          tar czf ../../../summit-${{ matrix.target }}.tar.gz summitd summit-ctl

      - name: Upload to release
        uses: softprops/action-gh-release@v1
        with:
          files: summit-${{ matrix.target }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
