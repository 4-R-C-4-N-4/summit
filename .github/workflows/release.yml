name: Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  release-docker:
    name: Release Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push multi-arch
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          body: |
            ## Summit Protocol ${{ steps.version.outputs.VERSION }}

            Peer-to-peer mesh networking for direct device communication.

            ### üê≥ Docker (Recommended)

            ```bash
            # Pull image
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}

            # Run Summit
            docker run -it --rm --privileged --network host \
              ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}

            # Inside container
            summitd wlp5s0

            # Access Web UI at http://127.0.0.1:9001
            ```

            ### üì¶ Installation Options

            **Docker Compose:**
            ```yaml
            services:
              summit:
                image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}
                privileged: true
                network_mode: host
                command: summitd wlp5s0
            ```

            **Native Linux (see Assets below):**
            - Download `summit-x86_64-unknown-linux-gnu.tar.gz` for Intel/AMD
            - Download `summit-aarch64-unknown-linux-gnu.tar.gz` for ARM64

            ### ‚ö° Quick Start

            ```bash
            # Trust a peer
            summit-ctl trust add <peer-pubkey>

            # Send a file
            summit-ctl send document.pdf

            # Check status
            summit-ctl status
            ```

            ### üîê Security Note

            Summit uses:
            - Noise_XX protocol for encryption
            - Trust-based security model (mutual trust required)
            - No automatic code execution
            - Bounded resource usage

            ### üìñ Documentation

            Full docs: https://github.com/${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-binaries:
    name: Build Native Binaries
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        target:
          - x86_64-unknown-linux-gnu
          - aarch64-unknown-linux-gnu
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Build binaries
        run: |
          cargo build --release --target ${{ matrix.target }} -p summitd
          cargo build --release --target ${{ matrix.target }} -p summit-ctl

      - name: Strip binaries
        run: |
          if [ "${{ matrix.target }}" = "aarch64-unknown-linux-gnu" ]; then
            aarch64-linux-gnu-strip target/${{ matrix.target }}/release/summitd || true
            aarch64-linux-gnu-strip target/${{ matrix.target }}/release/summit-ctl || true
          else
            strip target/${{ matrix.target }}/release/summitd || true
            strip target/${{ matrix.target }}/release/summit-ctl || true
          fi

      - name: Create archive
        run: |
          cd target/${{ matrix.target }}/release
          tar czf ../../../summit-${{ matrix.target }}.tar.gz summitd summit-ctl

      - name: Upload to release
        uses: softprops/action-gh-release@v1
        with:
          files: summit-${{ matrix.target }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
